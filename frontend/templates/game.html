<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Numeron</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            line-height: 1.6;
            margin: 0;
            padding: 0;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px 40px 20px;
        }
        
        .header {
            text-align: left;
            margin-bottom: 50px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px 0 0;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 40px;
        }
        
        .header h1 {
            font-size: 3rem;
            font-weight: 800;
            color: white;
            text-shadow: 0 4px 20px rgba(0,0,0,0.3);
            margin: 0;
            letter-spacing: -1px;
        }
        
        .header-description {
            color: white;
            font-size: 1.2rem;
            font-weight: 500;
            text-shadow: 0 2px 8px rgba(0,0,0,0.3);
            opacity: 0.95;
        }
        
        .header-help {
            color: white;
            font-size: 0.95rem;
            opacity: 0.85;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .header-help-content {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
        
        .header-help-content span {
            opacity: 0.9;
        }
        
        .header-help-content strong {
            font-weight: 600;
            opacity: 1;
        }
        
        .refresh-btn {
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            color: white;
            padding: 18px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.4rem;
            backdrop-filter: blur(10px);
        }
        
        .refresh-btn:hover {
            background: rgba(255,255,255,0.2);
            border-color: rgba(255,255,255,0.4);
            transform: scale(1.1);
        }
        
        .game-description {
            text-align: left;
            background: rgba(255,255,255,0.95);
            padding: 8px 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .game-description .description-text {
            color: #666;
            font-size: 0.9rem;
            margin: 0;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr 200px;
            gap: 30px;
            align-items: start;
            padding: 0 20px 0 0;
        }
        
        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 0;
            justify-content: flex-start;
        }
        
        .input-section {
            background: rgba(255,255,255,0.98);
            padding: 60px 50px;
            border-radius: 25px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.15);
            text-align: center;
            margin-top: 0;
            border: 1px solid rgba(255,255,255,0.2);
        }
        

        
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
        }
        
        .digit-inputs {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }
        
        .digit-input {
            padding: 15px;
            font-size: 1.2rem;
            font-weight: 700;
            border: 3px solid #e9ecef;
            border-radius: 15px;
            background: #f8f9fa;
            color: #495057;
            text-align: center;
            width: 60px;
            height: 50px;
            transition: all 0.3s ease;
        }
        
        .digit-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 5px rgba(102, 126, 234, 0.1);
            background: white;
        }
        
        .submit-btn {
            padding: 30px 50px;
            font-size: 1.4rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 700;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        
        .submit-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.4);
        }
        
        .message {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 600;
            text-align: center;
            display: none;
            min-height: 20px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-line;
            line-height: 1.4;
        }
        
        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .message.empty {
            background: transparent;
            border: none;
            color: transparent;
        }
        
        .message.double-call {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .items-header {
            text-align: center;
            margin: 30px 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .items-header h3 {
            font-size: 1.1rem;
            color: #667eea;
            font-weight: 700;
            margin: 0;
        }
        
        .items-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            margin-bottom: 15px;
        }
        
        .item-btn {
            padding: 12px 8px;
            font-size: 0.9rem;
            font-weight: 600;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            background: #f8f9fa;
            color: #495057;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            position: relative;
        }
        
        .item-btn:hover {
            background: #e9ecef;
            border-color: #667eea;
            transform: scale(1.02);
        }
        
        .item-btn.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .item-btn.selected:hover {
            background: #5a6fd8;
            border-color: #5a6fd8;
        }
        
        .item-btn:disabled {
            background: #e9ecef;
            color: #adb5bd;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .item-type {
            font-size: 0.7rem;
            opacity: 0.8;
            margin-top: 2px;
        }
        
        .item-ui {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            border: 2px solid #e9ecef;
        }
        
        .item-ui h4 {
            font-size: 1rem;
            color: #495057;
            margin: 0 0 10px 0;
            text-align: center;
        }
        
        .digit-selector {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
        }
        
        .digit-btn {
            padding: 8px;
            font-size: 1rem;
            font-weight: 600;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            background: #f8f9fa;
            color: #495057;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .digit-btn:hover {
            background: #e9ecef;
            border-color: #667eea;
        }
        
        .digit-btn.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .change-selector {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .position-selector, .group-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .position-selector label, .group-selector label {
            font-weight: 600;
            color: #495057;
            min-width: 60px;
        }
        
        .pos-btn, .group-btn {
            padding: 8px 12px;
            font-size: 0.9rem;
            font-weight: 600;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            background: #f8f9fa;
            color: #495057;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .pos-btn:hover, .group-btn:hover {
            background: #e9ecef;
            border-color: #667eea;
        }
        
        .pos-btn.selected, .group-btn.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .right-panel {
            background: rgba(255,255,255,0.98);
            border-radius: 25px;
            padding: 25px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            gap: 25px;
            height: auto;
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .history-section {
            flex: 1;
        }
        
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .history-header h2 {
            font-size: 1.4rem;
            color: #667eea;
            font-weight: 700;
        }
        
        .history-count {
            background: #667eea;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .history-list {
            overflow-y: visible;
        }
        
        .history-item {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 12px 18px;
            margin: 8px 0;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .history-turn {
            font-weight: 700;
            color: white;
            min-width: 40px;
            font-size: 1.1rem;
        }
        
        .history-guess {
            font-size: 1.4rem;
            font-weight: 800;
            color: white;
            margin: 0 20px;
            text-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .history-result {
            background: rgba(255,255,255,0.95);
            color: #667eea;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 800;
            font-size: 1.2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            min-width: 70px;
            text-align: center;
        }
        
        .history-subtitle {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
            letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .empty-history {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
            font-size: 1.3rem;
            font-weight: 500;
        }
        
        .help-section {
            background: #f8f9fa;
            padding: 15px 18px;
            border-radius: 12px;
            border-left: 4px solid #667eea;
        }
        
        .help-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            font-size: 0.9rem;
        }
        
        .help-summary span {
            color: #495057;
        }
        
        .help-summary strong {
            color: #667eea;
            font-weight: 600;
        }
        
        .memo-panel {
            background: rgba(255,255,255,0.98);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
            border: 1px solid rgba(255,255,255,0.2);
            min-height: 400px;
        }
        
        .memo-header {
            text-align: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .memo-header h2 {
            font-size: 1.2rem;
            color: #667eea;
            font-weight: 700;
            margin: 0;
        }
        
        .memo-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .memo-column {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .memo-btn {
            padding: 15px 6px;
            font-size: 1rem;
            font-weight: 700;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            background: #f8f9fa;
            color: #495057;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .memo-btn:hover {
            background: #e9ecef;
            border-color: #667eea;
            transform: scale(1.05);
        }
        
        .memo-btn.excluded {
            background: #6c757d;
            color: white;
            border-color: #6c757d;
            text-decoration: line-through;
        }
        
        .memo-btn.excluded:hover {
            background: #5a6268;
            border-color: #5a6268;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 2.5rem;
            }
            
            .refresh-btn {
                right: 10px;
                padding: 10px;
                font-size: 1rem;
            }
            
            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .input-group {
                flex-direction: column;
            }
            
            .digit-input {
                width: 150px;
            }
            
            .history-item {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <h1>Numeron</h1>
                <div class="header-description">3Ê°Å„ÅÆÊï∞Â≠ó„ÇíÂΩì„Å¶„Å¶„Åè„Å†„Åï„ÅÑÔºàÂêÑÊ°Å„ÅØ0„Äú9„ÅßÈáçË§á„Å™„ÅóÔºâ</div>
                <div class="header-help">
                    <div class="header-help-content">
                        <span><strong>EAT</strong>: Ê°Å„ÇÇÊï∞Â≠ó„ÇÇ‰∏ÄËá¥</span>
                        <span><strong>BITE</strong>: Êï∞Â≠ó„ÅÆ„Åø‰∏ÄËá¥</span>
                        <span><strong>3EAT</strong>„ÅßÂãùÂà©ÔºÅ</span>
                    </div>
                </div>
            </div>
            <button class="refresh-btn" onclick="refreshGame()">‚Üª</button>
        </div>
        
        <div class="main-content">
            <div class="left-panel">
                <div class="input-section">
                    <form method="post" class="input-group" onsubmit="return handleSubmit(event)">
                        <div class="digit-inputs">
                            <input type="text" name="digit1" maxlength="1" pattern="\d" required class="digit-input" autocomplete="off" spellcheck="false">
                            <input type="text" name="digit2" maxlength="1" pattern="\d" required class="digit-input" autocomplete="off" spellcheck="false">
                            <input type="text" name="digit3" maxlength="1" pattern="\d" required class="digit-input" autocomplete="off" spellcheck="false">
                        </div>
                        <button type="submit" class="submit-btn">Âà§ÂÆö</button>
                    </form>
                    
                    <div class="message {{ message_type if message else 'empty' }}">
                        {% if message %}
                            {{ message }}
                        {% endif %}
                    </div>
                    
                    <div class="items-header">
                        <h3>üß© ‰ΩøÁî®ÂèØËÉΩ„Ç¢„Ç§„ÉÜ„É†ÔºàÊúÄÂ§ß3„Å§„Åæ„ÅßÈÅ∏ÊäûÔºâ</h3>
                    </div>
                    <div class="items-grid">
                        <button class="item-btn" data-item="DOUBLE" data-type="ÊîªÊíÉ">
                            DOUBLE
                            <div class="item-type">ÊîªÊíÉ</div>
                        </button>
                        <button class="item-btn" data-item="HIGH_LOW" data-type="ÊîªÊíÉ">
                            HIGH_LOW
                            <div class="item-type">ÊîªÊíÉ</div>
                        </button>
                        <button class="item-btn" data-item="TARGET" data-type="ÊîªÊíÉ">
                            TARGET
                            <div class="item-type">ÊîªÊíÉ</div>
                        </button>
                    </div>
                    <div class="items-grid">
                        <button class="item-btn" data-item="SLASH" data-type="ÊîªÊíÉ">
                            SLASH
                            <div class="item-type">ÊîªÊíÉ</div>
                        </button>
                    </div>
                    
                    <!-- TARGET„Ç¢„Ç§„ÉÜ„É†Áî®„ÅÆÊï∞Â≠óÈÅ∏ÊäûUI -->
                    <div id="target-ui" class="item-ui" style="display: none;">
                        <h4>TARGET: Ë™ø„Åπ„ÇãÊï∞Â≠ó„ÇíÈÅ∏Êäû</h4>
                        <div class="digit-selector">
                            <button class="digit-btn" onclick="selectTargetDigit(0)">0</button>
                            <button class="digit-btn" onclick="selectTargetDigit(1)">1</button>
                            <button class="digit-btn" onclick="selectTargetDigit(2)">2</button>
                            <button class="digit-btn" onclick="selectTargetDigit(3)">3</button>
                            <button class="digit-btn" onclick="selectTargetDigit(4)">4</button>
                            <button class="digit-btn" onclick="selectTargetDigit(5)">5</button>
                            <button class="digit-btn" onclick="selectTargetDigit(6)">6</button>
                            <button class="digit-btn" onclick="selectTargetDigit(7)">7</button>
                            <button class="digit-btn" onclick="selectTargetDigit(8)">8</button>
                            <button class="digit-btn" onclick="selectTargetDigit(9)">9</button>
                        </div>
                    </div>
                    
                </div>
            </div>
            
            <div class="right-panel">
                <div class="history-section">
                    <div class="history-header">
                        <h2>‰∫àÊÉ≥Â±•Ê≠¥</h2>
                        <span class="history-subtitle">EAT-BITE</span>
                    </div>
                    
                    <div class="history-list">
                        {% if history %}
                            {% for item in history %}
                                <div class="history-item">
                                    <span class="history-turn">{{ item.split('.')[0] }}.</span>
                                    <span class="history-guess">{{ item.split('‚Üí')[0].split('.')[1].strip() }}</span>
                                    <span class="history-result">{{ item.split('‚Üí')[1].strip() }}</span>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="empty-history">
                                <p>ÈñãÂßãÂâç</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="memo-panel">
                <div class="memo-header">
                    <h2>memo</h2>
                </div>
                <div class="memo-grid">
                    <div class="memo-column">
                        <button class="memo-btn" onclick="toggleMemo(0)">0</button>
                        <button class="memo-btn" onclick="toggleMemo(1)">1</button>
                        <button class="memo-btn" onclick="toggleMemo(2)">2</button>
                        <button class="memo-btn" onclick="toggleMemo(3)">3</button>
                        <button class="memo-btn" onclick="toggleMemo(4)">4</button>
                    </div>
                    <div class="memo-column">
                        <button class="memo-btn" onclick="toggleMemo(5)">5</button>
                        <button class="memo-btn" onclick="toggleMemo(6)">6</button>
                        <button class="memo-btn" onclick="toggleMemo(7)">7</button>
                        <button class="memo-btn" onclick="toggleMemo(8)">8</button>
                        <button class="memo-btn" onclick="toggleMemo(9)">9</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // „É°„É¢Ê©üËÉΩ„ÅÆÁä∂ÊÖãÁÆ°ÁêÜ
        let excludedNumbers = new Set();
        
        // „Ç¢„Ç§„ÉÜ„É†ÈÅ∏Êäû„ÅÆÁä∂ÊÖãÁÆ°ÁêÜ
        let selectedItems = new Set();
        const MAX_ITEMS = 3;
        
        // TARGET„Ç¢„Ç§„ÉÜ„É†Áî®„ÅÆÁä∂ÊÖãÁÆ°ÁêÜ
        let selectedTargetDigit = null;
        
        function refreshGame() {
            // „É°„ÉÉ„Çª„Éº„Ç∏„Ç®„É™„Ç¢„Çí„ÇØ„É™„Ç¢
            const messageDiv = document.querySelector('.message');
            messageDiv.textContent = '';
            messageDiv.style.display = 'none';
            
            // „Éö„Éº„Ç∏„Çí„É™„É≠„Éº„Éâ
            window.location.href = '/?new_game=true';
        }
        
        function toggleMemo(number) {
            const button = event.target;
            if (excludedNumbers.has(number)) {
                // Èô§Â§ñÁä∂ÊÖã„ÇíËß£Èô§
                excludedNumbers.delete(number);
                button.classList.remove('excluded');
            } else {
                // Èô§Â§ñÁä∂ÊÖã„Å´„Åô„Çã
                excludedNumbers.add(number);
                button.classList.add('excluded');
            }
            
            // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Å´‰øùÂ≠ò
            localStorage.setItem('numeronExcludedNumbers', JSON.stringify(Array.from(excludedNumbers)));
        }
        
        function toggleItem(itemName) {
            console.log('toggleItem called with:', itemName);
            
            // „Éú„Çø„É≥„Çídata-itemÂ±ûÊÄß„ÅßÊ§úÁ¥¢
            const button = document.querySelector(`button[data-item="${itemName}"]`);
            console.log('button found:', button);
            
            if (!button) {
                console.log('Button not found, returning');
                return; // „Éú„Çø„É≥„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥Âêà„ÅØÂá¶ÁêÜ„Çí‰∏≠Êñ≠
            }
            
            console.log('Current selectedItems:', Array.from(selectedItems));
            
            if (selectedItems.has(itemName)) {
                // ÈÅ∏ÊäûËß£Èô§
                console.log('Removing item:', itemName);
                selectedItems.delete(itemName);
                button.classList.remove('selected');
                
                // UI„ÇíÈùûË°®Á§∫
                if (itemName === 'TARGET') {
                    document.getElementById('target-ui').style.display = 'none';
                    selectedTargetDigit = null;
                }
            } else {
                // ÈÅ∏Êäû
                if (selectedItems.size >= MAX_ITEMS) {
                    alert('ÊúÄÂ§ß3„Å§„Åæ„ÅßÈÅ∏Êäû„Åß„Åç„Åæ„Åô');
                    return;
                }
                console.log('Adding item:', itemName);
                selectedItems.add(itemName);
                button.classList.add('selected');
                
                // ÁâπÊÆäUI„ÇíË°®Á§∫
                if (itemName === 'TARGET') {
                    document.getElementById('target-ui').style.display = 'block';
                }
                
                // Êï∞Â≠óÂÖ•Âäõ„Åå‰∏çË¶Å„Å™„Ç¢„Ç§„ÉÜ„É†„ÅØÂç≥Â∫ß„Å´ÂÆüË°å
                if (['DOUBLE', 'HIGH_LOW', 'SLASH'].includes(itemName)) {
                    useItemImmediately(itemName);
                }
            }
            
            console.log('Updated selectedItems:', Array.from(selectedItems));
            
            // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Å´‰øùÂ≠ò
            localStorage.setItem('numeronSelectedItems', JSON.stringify(Array.from(selectedItems)));
            
            // ÈÅ∏ÊäûÁä∂ÊÖã„Å´Âøú„Åò„Å¶„Éú„Çø„É≥„ÅÆÊúâÂäπ/ÁÑ°Âäπ„ÇíÂàá„ÇäÊõø„Åà
            updateItemButtons();
        }
        
        function useItemImmediately(itemName) {
            console.log('Using item immediately:', itemName);
            
            fetch('/use-item', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ item: itemName })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // „Ç¢„Ç§„ÉÜ„É†ÂäπÊûú„ÇíË°®Á§∫
                    showItemResult(data.result.effect);
                    // „Ç¢„Ç§„ÉÜ„É†„ÇíÈÅ∏ÊäûËß£Èô§
                    selectedItems.delete(itemName);
                    const button = document.querySelector(`button[data-item="${itemName}"]`);
                    if (button) {
                        button.classList.remove('selected');
                    }
                    localStorage.setItem('numeronSelectedItems', JSON.stringify(Array.from(selectedItems)));
                    updateItemButtons();
                } else {
                    alert('„Ç¢„Ç§„ÉÜ„É†‰ΩøÁî®„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('„Ç¢„Ç§„ÉÜ„É†‰ΩøÁî®‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
            });
        }
        
        function updateItemButtons() {
            const itemButtons = document.querySelectorAll('.item-btn');
            itemButtons.forEach(button => {
                const itemName = button.getAttribute('data-item');
                if (!selectedItems.has(itemName) && selectedItems.size >= MAX_ITEMS) {
                    button.disabled = true;
                } else {
                    button.disabled = false;
                }
            });
        }
        
        function showItemResult(result) {
            // „Ç¢„Ç§„ÉÜ„É†ÁµêÊûú„Çí„É°„ÉÉ„Çª„Éº„Ç∏„Ç®„É™„Ç¢„Å´Ë°®Á§∫
            const messageDiv = document.querySelector('.message');
            
            // Êó¢Â≠ò„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØÊîπË°å„Åó„Å¶ËøΩÂä†
            if (messageDiv.textContent && messageDiv.textContent.trim() !== '') {
                messageDiv.textContent += '\n' + result;
            } else {
                messageDiv.textContent = result;
            }
            
            messageDiv.className = 'message info';
            messageDiv.style.display = 'flex';
        }
        
        function handleSubmit(event) {
            event.preventDefault();
            
            // 3„Å§„ÅÆÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„Åã„ÇâÊï∞Â≠ó„ÇíÂèñÂæó
            const digit1 = document.querySelector('input[name="digit1"]').value;
            const digit2 = document.querySelector('input[name="digit2"]').value;
            const digit3 = document.querySelector('input[name="digit3"]').value;
            
            // ÂÖ•ÂäõÂÄ§„ÅÆÁ¢∫Ë™ç
            if (!digit1 || !digit2 || !digit3) {
                alert('ÂÖ®„Å¶„ÅÆÊ°Å„Å´Êï∞Â≠ó„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return false;
            }
            
            // 3Ê°Å„ÅÆÊï∞Â≠ó„ÇíÁµêÂêà
            const guessStr = digit1 + digit2 + digit3;
            
            // Êï∞Â≠óÂÖ•Âäõ„ÅåÂøÖË¶Å„Å™„Ç¢„Ç§„ÉÜ„É†„Åã„ÉÅ„Çß„ÉÉ„ÇØ
            const requiresInput = ['TARGET'].some(item => selectedItems.has(item));
            
            if (requiresInput) {
                // „Ç¢„Ç§„ÉÜ„É†„ÅÆË¶Å‰ª∂„ÉÅ„Çß„ÉÉ„ÇØ
                for (let itemName of selectedItems) {
                    if (itemName === 'TARGET' && selectedTargetDigit === null) {
                        alert('TARGET„Ç¢„Ç§„ÉÜ„É†„Å´„ÅØÊï∞Â≠ó„ÅÆÈÅ∏Êäû„ÅåÂøÖË¶Å„Åß„Åô');
                        return false;
                    }
                }
                
                // „Éï„Ç©„Éº„É†„Å´„Ç¢„Ç§„ÉÜ„É†ÊÉÖÂ†±„ÇíËøΩÂä†
                const form = event.target;
                
                // Êó¢Â≠ò„ÅÆ„Ç¢„Ç§„ÉÜ„É†ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„ÇíÂâäÈô§
                form.querySelectorAll('input[name="used_items"]').forEach(input => input.remove());
                
                // Êñ∞„Åó„ÅÑ„Ç¢„Ç§„ÉÜ„É†ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„ÇíËøΩÂä†
                selectedItems.forEach(itemName => {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'used_items';
                    input.value = itemName;
                    form.appendChild(input);
                });
                
                // TARGET„Ç¢„Ç§„ÉÜ„É†„ÅÆÊï∞Â≠óÊÉÖÂ†±„ÇíËøΩÂä†
                if (selectedItems.has('TARGET') && selectedTargetDigit !== null) {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'target_digit';
                    input.value = selectedTargetDigit;
                    form.appendChild(input);
                }
                
                // 3Ê°Å„ÅÆÊï∞Â≠ó„ÇíÈö†„Åó„Éï„Ç£„Éº„É´„Éâ„Å´ËøΩÂä†
                const guessInput = document.createElement('input');
                guessInput.type = 'hidden';
                guessInput.name = 'guess';
                guessInput.value = guessStr;
                form.appendChild(guessInput);
                
                // „Éï„Ç©„Éº„É†„ÇíÈÄÅ‰ø°
                form.submit();
            } else {
                // Êï∞Â≠óÂÖ•Âäõ„Åå‰∏çË¶Å„Å™„Ç¢„Ç§„ÉÜ„É†„ÅØÁõ¥Êé•APIÂëº„Å≥Âá∫„Åó
                selectedItems.forEach(itemName => {
                    fetch('/use-item', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ item: itemName })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // „Ç¢„Ç§„ÉÜ„É†ÂäπÊûú„ÇíË°®Á§∫
                            showItemResult(data.result.effect);
                        } else {
                            alert('„Ç¢„Ç§„ÉÜ„É†‰ΩøÁî®„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('„Ç¢„Ç§„ÉÜ„É†‰ΩøÁî®‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
                    });
                });
                
                // 3Ê°Å„ÅÆÊï∞Â≠ó„ÇíÈö†„Åó„Éï„Ç£„Éº„É´„Éâ„Å´ËøΩÂä†„Åó„Å¶„Éï„Ç©„Éº„É†ÈÄÅ‰ø°
                const form = event.target;
                const guessInput = document.createElement('input');
                guessInput.type = 'hidden';
                guessInput.name = 'guess';
                guessInput.value = guessStr;
                form.appendChild(guessInput);
                form.submit();
            }
            
            // „Ç¢„Ç§„ÉÜ„É†ÈÅ∏ÊäûÁä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
            selectedItems.clear();
            selectedTargetDigit = null;
            
            // UI„Çí„É™„Çª„ÉÉ„Éà
            document.querySelectorAll('.item-btn').forEach(btn => btn.classList.remove('selected'));
            document.querySelectorAll('.digit-btn').forEach(btn => btn.classList.remove('selected'));
            document.getElementById('target-ui').style.display = 'none';
            
            // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Çí„ÇØ„É™„Ç¢
            localStorage.removeItem('numeronSelectedItems');
            updateItemButtons();
            
            return false;
        }
        
        function selectTargetDigit(digit) {
            selectedTargetDigit = digit;
            
            // „Éú„Çø„É≥„ÅÆÈÅ∏ÊäûÁä∂ÊÖã„ÇíÊõ¥Êñ∞
            document.querySelectorAll('.digit-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            event.target.classList.add('selected');
        }
        
        // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„Å´„É°„É¢Áä∂ÊÖã„ÇíÂæ©ÂÖÉ
        document.addEventListener('DOMContentLoaded', function() {
            // ÊúÄÂàù„ÅÆÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„Å´„Éï„Ç©„Éº„Ç´„Çπ
            document.querySelector('input[name="digit1"]').focus();
            
            // ÂÖ•Âäõ„Éï„Ç£„Éº„É´„ÉâÈñì„ÅÆËá™Âãï„Éï„Ç©„Éº„Ç´„ÇπÁßªÂãï
            const digitInputs = document.querySelectorAll('.digit-input');
            digitInputs.forEach((input, index) => {
                input.addEventListener('input', function() {
                    if (this.value.length === 1 && index < digitInputs.length - 1) {
                        digitInputs[index + 1].focus();
                    }
                });
                
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Backspace' && this.value === '' && index > 0) {
                        digitInputs[index - 1].focus();
                    }
                });
            });
            
            // „Ç¢„Ç§„ÉÜ„É†„Éú„Çø„É≥„Å´„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíËøΩÂä†
            const itemButtons = document.querySelectorAll('.item-btn');
            itemButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const itemName = this.getAttribute('data-item');
                    console.log('Item button clicked:', itemName);
                    toggleItem(itemName);
                });
            });
            
            // „É°„É¢Áä∂ÊÖã„ÇíÂæ©ÂÖÉ
            const savedExcluded = localStorage.getItem('numeronExcludedNumbers');
            if (savedExcluded) {
                excludedNumbers = new Set(JSON.parse(savedExcluded));
                updateMemoButtons();
            }
            
            // „Ç¢„Ç§„ÉÜ„É†ÈÅ∏ÊäûÁä∂ÊÖã„ÇíÂæ©ÂÖÉ
            const savedItems = localStorage.getItem('numeronSelectedItems');
            if (savedItems) {
                selectedItems = new Set(JSON.parse(savedItems));
                selectedItems.forEach(itemName => {
                    const button = document.querySelector(`button[data-item="${itemName}"]`);
                    if (button) {
                        button.classList.add('selected');
                        if (itemName === 'TARGET') {
                            document.getElementById('target-ui').style.display = 'block';
                        }
                    }
                });
                updateItemButtons();
            }
            
            // DOUBLE„Ç≥„Éº„É´Áä∂ÊÖã„Çí„ÉÅ„Çß„ÉÉ„ÇØ
            checkDoubleCallStatus();
        });
        
        function checkDoubleCallStatus() {
            // „Çª„ÉÉ„Ç∑„Éß„É≥„Åã„ÇâDOUBLE„Ç≥„Éº„É´ÂèØËÉΩÁä∂ÊÖã„ÇíÁ¢∫Ë™ç
            fetch('/check-double-call')
                .then(response => response.json())
                .then(data => {
                    if (data.double_call_available) {
                        // DOUBLE„Ç≥„Éº„É´ÂèØËÉΩ„Å™Â†¥Âêà„ÄÅÁâπÂà•„Å™UI„ÇíË°®Á§∫
                        showDoubleCallUI();
                    }
                })
                .catch(error => console.error('Error checking double call status:', error));
        }
        
        function showDoubleCallUI() {
            // DOUBLE„Ç≥„Éº„É´Áî®„ÅÆÁâπÂà•„Å™UI„ÇíË°®Á§∫
            const messageDiv = document.querySelector('.message');
            messageDiv.textContent = 'DOUBLEÂäπÊûúÁô∫Âãï‰∏≠ÔºÅ2ÂõûÈÄ£Á∂ö„Åß„Ç≥„Éº„É´„Åß„Åç„Åæ„Åô';
            messageDiv.className = 'message double-call';
            messageDiv.style.display = 'flex';
        }
    </script>
</body>
</html> 